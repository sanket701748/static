name: Deploy code via SSM Run Command (download & unzip)
  run: |
    REPO_URL="https://api.github.com/repos/your-user/your-repo/zipball/main"

    COMMAND_ID=$(aws ssm send-command \
      --instance-ids ${{ secrets.EC2_INSTANCE_ID }} \
      --document-name "AWS-RunShellScript" \
      --comment "Deploy from GitHub Actions" \
      --parameters commands="[
        'cd /var/www/html',
        'sudo rm -rf *',
        'curl -L -H \"Authorization: token ${{ secrets.GITHUB_TOKEN_SSM }}\" -o latest.zip $REPO_URL',
        'unzip latest.zip',
        'mv $(unzip -Z -1 latest.zip | head -1 | cut -f1 -d\"/\")/* ./',
        'rm -rf latest.zip',
        'sudo chown -R www-data:www-data /var/www/html',
        'sudo chmod -R 755 /var/www/html'
      ]" \
      --query "Command.CommandId" --output text)

    echo "Command ID: $COMMAND_ID"
    sleep 20

    aws ssm get-command-invocation \
      --command-id $COMMAND_ID \
      --instance-id ${{ secrets.EC2_INSTANCE_ID }}
