name: Deploy Static Website via SSM (OIDC Auth)

on:
  push:
    branches:
      - main

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: arn:aws:iam::787187108815:role/GitHubOIDC-DeployRole
          aws-region: us-east-1

      - name: Deploy via SSM to EC2
        id: ssm_deploy
        - name: Wait for SSM and Fetch Output
  run: |
    echo "Waiting for SSM command to complete..."
    for i in {1..20}; do
      STATUS=$(aws ssm get-command-invocation \
        --command-id "18400636-2dab-4481-8e98-694c551683bc" \
        --instance-id "i-0f1bef28a30a63f12" \
        --region us-east-1 \
        --query "Status" \
        --output text)

      echo "Current Status: $STATUS"

      if [[ "$STATUS" == "Success" ]]; then
        echo "✅ SSM command succeeded!"
        break
      elif [[ "$STATUS" == "Failed" ]]; then
        echo "❌ SSM command failed. Error output:"
        aws ssm get-command-invocation \
          --command-id "18400636-2dab-4481-8e98-694c551683bc" \
          --instance-id "i-0f1bef28a30a63f12" \
          --region us-east-1 \
          --query "StandardErrorContent" \
          --output text
        exit 1
      else
        echo "⏳ Still waiting..."
        sleep 10
      fi
    done
