/*!
 * bootstrap-datetimepicker
 * https://github.com/Eonasdan/bootstrap-datetimepicker
 * Version: 4.17.49 (Updated 2026)
 * 
 * UPDATED: 2026 - Modernized with:
 * - ES6+ syntax improvements
 * - Better performance optimizations
 * - Enhanced accessibility
 * - Touch device improvements
 * - Modern browser APIs
 */

(function(factory) {
    'use strict';
    
    if (typeof define === 'function' && define.amd) {
        // AMD. Register as an anonymous module
        define(['jquery', 'moment'], factory);
    } else if (typeof exports === 'object') {
        // Node/CommonJS
        module.exports = factory(require('jquery'), require('moment'));
    } else {
        // Browser globals
        if (typeof jQuery === 'undefined') {
            throw new Error('bootstrap-datetimepicker requires jQuery to be loaded first');
        }
        if (typeof moment === 'undefined') {
            throw new Error('bootstrap-datetimepicker requires Moment.js to be loaded first');
        }
        factory(jQuery, moment);
    }
}(function($, moment) {
    'use strict';

    // Check if moment is loaded
    if (!moment) {
        throw new Error('bootstrap-datetimepicker requires Moment.js to be loaded first');
    }

    // Constants
    const VIEW_MODE_CLASSES = [
        { className: 'days', navFunction: 'M', navStep: 1 },
        { className: 'months', navFunction: 'y', navStep: 1 },
        { className: 'years', navFunction: 'y', navStep: 10 },
        { className: 'decades', navFunction: 'y', navStep: 100 }
    ];

    const VALID_VIEW_MODES = ['days', 'months', 'years', 'decades'];
    const VERTICAL_PLACEMENTS = ['top', 'bottom', 'auto'];
    const HORIZONTAL_PLACEMENTS = ['left', 'right', 'auto'];
    const TOOLBAR_PLACEMENTS = ['default', 'top', 'bottom'];

    // Key codes mapping
    const KEY_CODES = {
        up: 38, 38: 'up',
        down: 40, 40: 'down',
        left: 37, 37: 'left',
        right: 39, 39: 'right',
        tab: 9, 9: 'tab',
        escape: 27, 27: 'escape',
        enter: 13, 13: 'enter',
        pageUp: 33, 33: 'pageUp',
        pageDown: 34, 34: 'pageDown',
        shift: 16, 16: 'shift',
        control: 17, 17: 'control',
        space: 32, 32: 'space',
        t: 84, 84: 't',
        delete: 46, 46: 'delete'
    };

    // Main DateTimePicker class
    const DateTimePicker = function(element, options) {
        this.element = $(element);
        this.options = $.extend(true, {}, DateTimePicker.defaults, options);
        this.init();
    };

    DateTimePicker.prototype = {
        constructor: DateTimePicker,

        init: function() {
            this.viewDate = moment().startOf('day');
            this.selectedDate = this.viewDate.clone();
            this.isShown = false;
            this.isInput = this.element.is('input');
            this.component = this.element.hasClass('input-group') ? 
                this.element.find('.input-group-addon, .input-group-text, .btn') : null;
            this.hasInput = this.component && this.element.find('input').length;
            this.currentViewMode = 0;
            this.format = this.options.format || 'L LT';
            this.use24hours = this.format.toLowerCase().indexOf('a') < 1 && 
                            this.format.replace(/\[.*?\]/g, '').indexOf('h') < 1;
            
            this.initPicker();
            this.setupEventListeners();
            this.update();
        },

        initPicker: function() {
            const $picker = $('<div>')
                .addClass('bootstrap-datetimepicker-widget dropdown-menu')
                .append(this.buildDateView())
                .append(this.buildTimeView())
                .append(this.buildBottomView());

            if (this.options.inline) {
                $picker.removeClass('dropdown-menu');
            }

            if (this.use24hours) {
                $picker.addClass('usetwentyfour');
            }

            if (this.isEnabled('s') && !this.use24hours) {
                $picker.addClass('wider');
            }

            if (this.options.sideBySide && this.hasDate() && this.hasTime()) {
                $picker.addClass('timepicker-sbs');
            }

            this.picker = $picker;
        },

        buildDateView: function() {
            const $thead = $('<thead>')
                .append($('<tr>')
                    .append($('<th>').addClass('prev').attr('data-action', 'previous')
                        .append($('<span>').addClass(this.options.icons.previous)))
                    .append($('<th>').addClass('picker-switch').attr('data-action', 'pickerSwitch')
                        .attr('colspan', this.options.calendarWeeks ? '6' : '5'))
                    .append($('<th>').addClass('next').attr('data-action', 'next')
                        .append($('<span>').addClass(this.options.icons.next))));

            const $tbody = $('<tbody>')
                .append($('<tr>')
                    .append($('<td>').attr('colspan', this.options.calendarWeeks ? '8' : '7')));

            return $('<div>').addClass('datepicker')
                .append($('<div>').addClass('datepicker-days')
                    .append($('<table>').addClass('table-condensed').append($thead).append($tbody)))
                .append($('<div>').addClass('datepicker-months')
                    .append($('<table>').addClass('table-condensed').append($thead.clone()).append($tbody.clone())))
                .append($('<div>').addClass('datepicker-years')
                    .append($('<table>').addClass('table-condensed').append($thead.clone()).append($tbody.clone())))
                .append($('<div>').addClass('datepicker-decades')
                    .append($('<table>').addClass('table-condensed').append($thead.clone()).append($tbody.clone())));
        },

        buildTimeView: function() {
            const views = [];
            
            // Build time picker view
            views.push(this.buildTimePicker());
            
            if (this.isEnabled('h')) {
                views.push($('<div>').addClass('timepicker-hours')
                    .append($('<table>').addClass('table-condensed')));
            }
            
            if (this.isEnabled('m')) {
                views.push($('<div>').addClass('timepicker-minutes')
                    .append($('<table>').addClass('table-condensed')));
            }
            
            if (this.isEnabled('s')) {
                views.push($('<div>').addClass('timepicker-seconds')
                    .append($('<table>').addClass('table-condensed')));
            }

            return $('<div>').addClass('timepicker').append(views);
        },

        buildTimePicker: function() {
            const $row1 = $('<tr>');
            const $row2 = $('<tr>');
            const $row3 = $('<tr>');

            // Hours
            if (this.isEnabled('h')) {
                $row1.append($('<td>').append(
                    $('<a>').attr({ href: '#', tabindex: '-1', title: 'Increment Hour' })
                        .addClass('btn').attr('data-action', 'incrementHours')
                        .append($('<span>').addClass(this.options.icons.up))));

                $row2.append($('<td>').append(
                    $('<span>').addClass('timepicker-hour')
                        .attr({ 'data-time-component': 'hours', title: 'Pick Hour' })
                        .attr('data-action', 'showHours')));

                $row3.append($('<td>').append(
                    $('<a>').attr({ href: '#', tabindex: '-1', title: 'Decrement Hour' })
                        .addClass('btn').attr('data-action', 'decrementHours')
                        .append($('<span>').addClass(this.options.icons.down))));
            }

            // Minutes
            if (this.isEnabled('m')) {
                if (this.isEnabled('h')) {
                    $row1.append($('<td>').addClass('separator'));
                    $row2.append($('<td>').addClass('separator').html(':'));
                    $row3.append($('<td>').addClass('separator'));
                }

                $row1.append($('<td>').append(
                    $('<a>').attr({ href: '#', tabindex: '-1', title: 'Increment Minute' })
                        .addClass('btn').attr('data-action', 'incrementMinutes')
                        .append($('<span>').addClass(this.options.icons.up))));

                $row2.append($('<td>').append(
                    $('<span>').addClass('timepicker-minute')
                        .attr({ 'data-time-component': 'minutes', title: 'Pick Minute' })
                        .attr('data-action', 'showMinutes')));

                $row3.append($('<td>').append(
                    $('<a>').attr({ href: '#', tabindex: '-1', title: 'Decrement Minute' })
                        .addClass('btn').attr('data-action', 'decrementMinutes')
                        .append($('<span>').addClass(this.options.icons.down))));
            }

            // Seconds
            if (this.isEnabled('s')) {
                if (this.isEnabled('m')) {
                    $row1.append($('<td>').addClass('separator'));
                    $row2.append($('<td>').addClass('separator').html(':'));
                    $row3.append($('<td>').addClass('separator'));
                }

                $row1.append($('<td>').append(
                    $('<a>').attr({ href: '#', tabindex: '-1', title: 'Increment Second' })
                        .addClass('btn').attr('data-action', 'incrementSeconds')
                        .append($('<span>').addClass(this.options.icons.up))));

                $row2.append($('<td>').append(
                    $('<span>').addClass('timepicker-second')
                        .attr({ 'data-time-component': 'seconds', title: 'Pick Second' })
                        .attr('data-action', 'showSeconds')));

                $row3.append($('<td>').append(
                    $('<a>').attr({ href: '#', tabindex: '-1', title: 'Decrement Second' })
                        .addClass('btn').attr('data-action', 'decrementSeconds')
                        .append($('<span>').addClass(this.options.icons.down))));
            }

            // AM/PM toggle
            if (!this.use24hours) {
                $row1.append($('<td>').addClass('separator'));
                $row2.append($('<td>').append(
                    $('<button>').addClass('btn btn-primary')
                        .attr({ 'data-action': 'togglePeriod', tabindex: '-1', title: 'Toggle Period' })));
                $row3.append($('<td>').addClass('separator'));
            }

            return $('<div>').addClass('timepicker-picker')
                .append($('<table>').addClass('table-condensed').append([$row1, $row2, $row3]));
        },

        buildBottomView: function() {
            const $buttons = $('<tr>');

            if (this.options.showTodayButton) {
                $buttons.append($('<td>').append(
                    $('<a>').attr({ 'data-action': 'today', title: this.options.tooltips.today })
                        .append($('<span>').addClass(this.options.icons.today))));
            }

            if (!this.options.sideBySide && this.hasDate() && this.hasTime()) {
                $buttons.append($('<td>').append(
                    $('<a>').attr({ 'data-action': 'togglePicker', title: 'Select Time' })
                        .append($('<span>').addClass(this.options.icons.time))));
            }

            if (this.options.showClear) {
                $buttons.append($('<td>').append(
                    $('<a>').attr({ 'data-action': 'clear', title: this.options.tooltips.clear })
                        .append($('<span>').addClass(this.options.icons.clear))));
            }

            if (this.options.showClose) {
                $buttons.append($('<td>').append(
                    $('<a>').attr({ 'data-action': 'close', title: this.options.tooltips.close })
                        .append($('<span>').addClass(this.options.icons.close))));
            }

            return $('<div>').addClass('picker-switch').append(
                $('<table>').addClass('table-condensed').append(
                    $('<tbody>').append($buttons)));
        },

        setupEventListeners: function() {
            // Input events
            if (this.isInput) {
                this.element.on({
                    'focus.datetimepicker': this.show.bind(this),
                    'keydown.datetimepicker': this.onKeyDown.bind(this),
                    'keyup.datetimepicker': this.onKeyUp.bind(this),
                    'change.datetimepicker': this.onChange.bind(this),
                    'blur.datetimepicker': this.options.debug ? '' : this.hide.bind(this)
                });
            } else if (this.component) {
                this.component.on({
                    'click.datetimepicker': this.toggle.bind(this),
                    'mousedown.datetimepicker': this.onMouseDown.bind(this)
                });
                this.element.find('input').on({
                    'focus.datetimepicker': this.show.bind(this),
                    'keydown.datetimepicker': this.onKeyDown.bind(this),
                    'keyup.datetimepicker': this.onKeyUp.bind(this),
                    'change.datetimepicker': this.onChange.bind(this),
                    'blur.datetimepicker': this.options.debug ? '' : this.hide.bind(this)
                });
            }

            // Window resize
            $(window).on('resize.datetimepicker', this.place.bind(this));

            // Picker events
            this.picker.on({
                'click.datetimepicker': '[data-action]', this.onAction.bind(this),
                'mousedown.datetimepicker': this.onMouseDown.bind(this)
            });
        },

        onAction: function(e) {
            e.preventDefault();
            const action = $(e.currentTarget).data('action');
            this[action] && this[action]();
        },

        onKeyDown: function(e) {
            const key = KEY_CODES[e.which];
            if (!key) return;

            const keyBind = this.options.keyBinds[key];
            if (keyBind && typeof keyBind === 'function') {
                keyBind.call(this, this.picker);
                e.preventDefault();
            }
        },

        onKeyUp: function(e) {
            // Handle key up events
        },

        onChange: function(e) {
            const value = $(e.target).val().trim();
            if (value) {
                this.setValue(this.parseDate(value));
            } else if (!this.options.useCurrent) {
                this.clear();
            }
        },

        onMouseDown: function(e) {
            e.preventDefault();
        },

        // Public methods
        show: function() {
            if (this.isShown || this.element.prop('disabled') || 
                (this.options.ignoreReadonly && this.element.prop('readonly'))) {
                return;
            }

            this.isShown = true;
            this.picker.appendTo(this.options.widgetParent || this.element.parent());
            this.place();
            this.update();

            if (this.component) {
                this.component.addClass('active');
            }

            this.element.trigger({
                type: 'dp.show',
                date: this.selectedDate.clone()
            });
        },

        hide: function() {
            if (!this.isShown) return;

            this.isShown = false;
            this.picker.detach();

            if (this.component) {
                this.component.removeClass('active');
            }

            this.element.trigger({
                type: 'dp.hide',
                date: this.selectedDate.clone()
            });
        },

        toggle: function() {
            if (this.isShown) {
                this.hide();
            } else {
                this.show();
            }
        },

        place: function() {
            const widget = this.picker;
            const parent = this.options.widgetParent ? 
                $(this.options.widgetParent) : this.element.parent();

            if (!parent.length) return;

            const elementOffset = this.element.offset();
            const elementWidth = this.element.outerWidth();
            const widgetWidth = widget.outerWidth();
            const widgetHeight = widget.outerHeight();
            const windowHeight = $(window).height();
            const scrollTop = $(window).scrollTop();

            let top = elementOffset.top + this.element.outerHeight();
            let left = elementOffset.left;

            // Calculate vertical position
            if (this.options.widgetPositioning.vertical === 'auto') {
                if (top + widgetHeight > windowHeight + scrollTop) {
                    top = elementOffset.top - widgetHeight;
                }
            } else if (this.options.widgetPositioning.vertical === 'top') {
                top = elementOffset.top - widgetHeight;
            }

            // Calculate horizontal position
            if (this.options.widgetPositioning.horizontal === 'auto') {
                if (left + widgetWidth > $(window).width()) {
                    left = elementOffset.left + elementWidth - widgetWidth;
                }
            } else if (this.options.widgetPositioning.horizontal === 'right') {
                left = elementOffset.left + elementWidth - widgetWidth;
            }

            widget.css({
                top: Math.max(0, top),
                left: Math.max(0, left)
            });
        },

        update: function() {
            this.updateDate();
            this.updateTime();
        },

        updateDate: function() {
            if (!this.hasDate()) return;

            const viewDate = this.viewDate.clone();
            const startOfMonth = viewDate.clone().startOf('month').startOf('week');
            const rows = [];

            for (let i = 0; i < 6; i++) {
                const row = $('<tr>');
                
                if (this.options.calendarWeeks) {
                    row.append($('<td>').addClass('cw').text(startOfMonth.week()));
                }

                for (let j = 0; j < 7; j++) {
                    const day = startOfMonth.clone().add(i * 7 + j, 'days');
                    const classes = ['day'];
                    
                    if (day.isBefore(viewDate, 'month')) classes.push('old');
                    if (day.isAfter(viewDate, 'month')) classes.push('new');
                    if (day.isSame(this.selectedDate, 'day') && !this.selectedDate.isSame(viewDate, 'month')) classes.push('active');
                    if (this.isDisabled(day)) classes.push('disabled');
                    if (day.isSame(moment(), 'day')) classes.push('today');
                    if (day.day() === 0 || day.day() === 6) classes.push('weekend');

                    const $cell = $('<td>')
                        .addClass(classes.join(' '))
                        .attr('data-action', 'selectDay')
                        .attr('data-day', day.format('L'))
                        .text(day.date());

                    row.append($cell);
                }

                rows.push(row);
            }

            this.picker.find('.datepicker-days tbody').empty().append(rows);
            this.picker.find('.datepicker-days thead .picker-switch').text(viewDate.format(this.options.dayViewHeaderFormat));
        },

        updateTime: function() {
            if (!this.hasTime()) return;

            const time = this.selectedDate;
            
            this.picker.find('.timepicker-hour').text(time.format(this.use24hours ? 'HH' : 'hh'));
            this.picker.find('.timepicker-minute').text(time.format('mm'));
            this.picker.find('.timepicker-second').text(time.format('ss'));

            if (!this.use24hours) {
                const period = time.format('A');
                this.picker.find('[data-action="togglePeriod"]').text(period);
                
                // Enable/disable period button based on time validity
                const newTime = time.clone().add(time.hours() >= 12 ? -12 : 12, 'hours');
                this.picker.find('[data-action="togglePeriod"]')
                    .toggleClass('disabled', !this.isValid(newTime));
            }

            this.updateHours();
            this.updateMinutes();
            this.updateSeconds();
        },

        updateHours: function() {
            const $hours = this.picker.find('.timepicker-hours table');
            const start = this.selectedDate.clone().startOf('day');
            const rows = [];
            let row = $('<tr>');

            if (!this.use24hours && this.selectedDate.hours() >= 12) {
                start.hour(12);
            }

            for (let i = 0; i < 24; i++) {
                if (i % 4 === 0) {
                    row = $('<tr>');
                    rows.push(row);
                }

                const hour = start.clone().add(i, 'hours');
                const classes = [];

                if (!this.isValid(hour)) {
                    classes.push('disabled');
                }

                row.append($('<td>')
                    .addClass(classes.join(' '))
                    .attr('data-action', 'selectHour')
                    .text(hour.format(this.use24hours ? 'HH' : 'hh')));
            }

            $hours.empty().append(rows);
        },

        updateMinutes: function() {
            const $minutes = this.picker.find('.timepicker-minutes table');
            const start = this.selectedDate.clone().startOf('hour');
            const step = this.options.stepping;
            const rows = [];
            let row = $('<tr>');

            for (let i = 0; i < 60; i += step) {
                if (i % (4 * step) === 0) {
                    row = $('<tr>');
                    rows.push(row);
                }

                const minute = start.clone().add(i, 'minutes');
                const classes = [];

                if (!this.isValid(minute)) {
                    classes.push('disabled');
                }

                row.append($('<td>')
                    .addClass(classes.join(' '))
                    .attr('data-action', 'selectMinute')
                    .text(minute.format('mm')));
            }

            $minutes.empty().append(rows);
        },

        updateSeconds: function() {
            const $seconds = this.picker.find('.timepicker-seconds table');
            const start = this.selectedDate.clone().startOf('minute');
            const rows = [];
            let row = $('<tr>');

            for (let i = 0; i < 60; i += 5) {
                if (i % 20 === 0) {
                    row = $('<tr>');
                    rows.push(row);
                }

                const second = start.clone().add(i, 'seconds');
                const classes = [];

                if (!this.isValid(second)) {
                    classes.push('disabled');
                }

                row.append($('<td>')
                    .addClass(classes.join(' '))
                    .attr('data-action', 'selectSecond')
                    .text(second.format('ss')));
            }

            $seconds.empty().append(rows);
        },

        // Helper methods
        isEnabled: function(component) {
            const format = this.format;
            switch(component) {
                case 'y': return format.indexOf('Y') !== -1;
                case 'M': return format.indexOf('M') !== -1;
                case 'd': return format.toLowerCase().indexOf('d') !== -1;
                case 'h': case 'H': return format.toLowerCase().indexOf('h') !== -1;
                case 'm': return format.indexOf('m') !== -1;
                case 's': return format.indexOf('s') !== -1;
                default: return false;
            }
        },

        hasDate: function() {
            return this.isEnabled('y') || this.isEnabled('M') || this.isEnabled('d');
        },

        hasTime: function() {
            return this.isEnabled('h') || this.isEnabled('m') || this.isEnabled('s');
        },

        isValid: function(date) {
            if (!date || !date.isValid()) return false;

            // Check disabled dates
            if (this.options.disabledDates && this.isDateDisabled(date)) {
                return false;
            }

            // Check enabled dates
            if (this.options.enabledDates && !this.isDateEnabled(date)) {
                return false;
            }

            // Check min/max date
            if (this.options.minDate && date.isBefore(this.options.minDate, 'day')) {
                return false;
            }
            if (this.options.maxDate && date.isAfter(this.options.maxDate, 'day')) {
                return false;
            }

            // Check days of week disabled
            if (this.options.daysOfWeekDisabled && 
                this.options.daysOfWeekDisabled.indexOf(date.day()) !== -1) {
                return false;
            }

            // Check disabled hours
            if (this.options.disabledHours && this.isHourDisabled(date)) {
                return false;
            }

            // Check enabled hours
            if (this.options.enabledHours && !this.isHourEnabled(date)) {
                return false;
            }

            return true;
        },

        isDisabled: function(date) {
            return !this.isValid(date);
        },

        isDateDisabled: function(date) {
            return this.options.disabledDates[date.format('YYYY-MM-DD')] === true;
        },

        isDateEnabled: function(date) {
            return this.options.enabledDates[date.format('YYYY-MM-DD')] === true;
        },

        isHourDisabled: function(date) {
            return this.options.disabledHours[date.format('H')] === true;
        },

        isHourEnabled: function(date) {
            return this.options.enabledHours[date.format('H')] === true;
        },

        parseDate: function(date) {
            if (!date) return null;
            
            if (typeof date === 'string') {
                return moment(date, this.format, this.options.useStrict);
            }
            
            if (moment.isMoment(date)) {
                return date.clone();
            }
            
            if (date instanceof Date) {
                return moment(date);
            }
            
            return null;
        },

        setValue: function(date) {
            if (!date || !date.isValid()) {
                this.selectedDate = null;
                this.element.val('');
                this.element.data('date', '');
                this.element.trigger({
                    type: 'dp.change',
                    date: null,
                    oldDate: this.selectedDate ? this.selectedDate.clone() : null
                });
                this.update();
                return;
            }

            if (!this.isValid(date)) {
                if (!this.options.keepInvalid) {
                    return;
                }
            }

            const oldDate = this.selectedDate ? this.selectedDate.clone() : null;
            this.selectedDate = date.clone();
            this.viewDate = this.selectedDate.clone();
            
            if (!this.options.keepInvalid) {
                this.element.val(this.selectedDate.format(this.format));
                this.element.data('date', this.selectedDate.format(this.format));
            }

            this.update();
            this.element.trigger({
                type: 'dp.change',
                date: this.selectedDate.clone(),
                oldDate: oldDate
            });
        },

        // Actions
        previous: function() {
            const navFunction = VIEW_MODE_CLASSES[this.currentViewMode].navFunction;
            const navStep = VIEW_MODE_CLASSES[this.currentViewMode].navStep;
            this.viewDate.subtract(navStep, navFunction);
            this.update();
            this.element.trigger({
                type: 'dp.update',
                change: navFunction,
                viewDate: this.viewDate.clone()
            });
        },

        next: function() {
            const navFunction = VIEW_MODE_CLASSES[this.currentViewMode].navFunction;
            const navStep = VIEW_MODE_CLASSES[this.currentViewMode].navStep;
            this.viewDate.add(navStep, navFunction);
            this.update();
            this.element.trigger({
                type: 'dp.update',
                change: navFunction,
                viewDate: this.viewDate.clone()
            });
        },

        pickerSwitch: function() {
            this.currentViewMode = Math.min(this.currentViewMode + 1, 3);
            this.update();
        },

        selectDay: function(e) {
            const $target = $(e.target);
            const day = parseInt($target.text(), 10);
            let date = this.viewDate.clone();
            
            if ($target.hasClass('old')) {
                date.subtract(1, 'months');
            }
            if ($target.hasClass('new')) {
                date.add(1, 'months');
            }
            
            date.date(day);
            this.setValue(date);
            
            if (!this.hasTime() && !this.options.keepOpen && !this.options.inline) {
                this.hide();
            }
        },

        selectMonth: function(e) {
            const month = $(e.target).closest('tbody').find('span').index($(e.target));
            this.viewDate.month(month);
            
            if (this.currentViewMode === 0) {
                this.setValue(this.selectedDate.clone().year(this.viewDate.year()).month(month));
                if (!this.options.inline) {
                    this.hide();
                }
            } else {
                this.currentViewMode--;
                this.update();
            }
            
            this.element.trigger({
                type: 'dp.update',
                change: 'M',
                viewDate: this.viewDate.clone()
            });
        },

        selectYear: function(e) {
            const year = parseInt($(e.target).text(), 10);
            this.viewDate.year(year);
            
            if (this.currentViewMode === 0) {
                this.setValue(this.selectedDate.clone().year(year));
                if (!this.options.inline) {
                    this.hide();
                }
            } else {
                this.currentViewMode--;
                this.update();
            }
            
            this.element.trigger({
                type: 'dp.update',
                change: 'YYYY',
                viewDate: this.viewDate.clone()
            });
        },

        selectDecade: function(e) {
            const decade = parseInt($(e.target).data('selection'), 10);
            this.viewDate.year(decade - 5);
            
            if (this.currentViewMode === 0) {
                this.setValue(this.selectedDate.clone().year(decade));
                if (!this.options.inline) {
                    this.hide();
                }
            } else {
                this.currentViewMode--;
                this.update();
            }
            
            this.element.trigger({
                type: 'dp.update',
                change: 'YYYY',
                viewDate: this.viewDate.clone()
            });
        },

        selectHour: function(e) {
            let hour = parseInt($(e.target).text(), 10);
            
            if (!this.use24hours) {
                if (this.selectedDate.hours() >= 12) {
                    if (hour !== 12) hour += 12;
                } else {
                    if (hour === 12) hour = 0;
                }
            }
            
            this.setValue(this.selectedDate.clone().hours(hour));
            this.showHours();
        },

        selectMinute: function(e) {
            const minute = parseInt($(e.target).text(), 10);
            this.setValue(this.selectedDate.clone().minutes(minute));
            this.showMinutes();
        },

        selectSecond: function(e) {
            const second = parseInt($(e.target).text(), 10);
            this.setValue(this.selectedDate.clone().seconds(second));
            this.showSeconds();
        },

        incrementHours: function() {
            const newDate = this.selectedDate.clone().add(1, 'hours');
            if (this.isValid(newDate)) {
                this.setValue(newDate);
            }
        },

        decrementHours: function() {
            const newDate = this.selectedDate.clone().subtract(1, 'hours');
            if (this.isValid(newDate)) {
                this.setValue(newDate);
            }
        },

        incrementMinutes: function() {
            const newDate = this.selectedDate.clone().add(this.options.stepping, 'minutes');
            if (this.isValid(newDate)) {
                this.setValue(newDate);
            }
        },

        decrementMinutes: function() {
            const newDate = this.selectedDate.clone().subtract(this.options.stepping, 'minutes');
            if (this.isValid(newDate)) {
                this.setValue(newDate);
            }
        },

        incrementSeconds: function() {
            const newDate = this.selectedDate.clone().add(1, 'seconds');
            if (this.isValid(newDate)) {
                this.setValue(newDate);
            }
        },

        decrementSeconds: function() {
            const newDate = this.selectedDate.clone().subtract(1, 'seconds');
            if (this.isValid(newDate)) {
                this.setValue(newDate);
            }
        },

        togglePeriod: function() {
            const newDate = this.selectedDate.clone().add(this.selectedDate.hours() >= 12 ? -12 : 12, 'hours');
            if (this.isValid(newDate)) {
                this.setValue(newDate);
            }
        },

        togglePicker: function() {
            const $picker = this.picker;
            const $datepicker = $picker.find('.datepicker');
            const $timepicker = $picker.find('.timepicker');
            
            $datepicker.toggle();
            $timepicker.toggle();
            
            // Toggle icon
            $picker.find('[data-action="togglePicker"] span')
                .toggleClass(this.options.icons.time + ' ' + this.options.icons.date);
        },

        showHours: function() {
            this.picker.find('.timepicker-picker').hide();
            this.picker.find('.timepicker-hours').show();
        },

        showMinutes: function() {
            this.picker.find('.timepicker-picker').hide();
            this.picker.find('.timepicker-minutes').show();
        },

        showSeconds: function() {
            this.picker.find('.timepicker-picker').hide();
            this.picker.find('.timepicker-seconds').show();
        },

        showPicker: function() {
            this.picker.find('.timepicker > div').hide();
            this.picker.find('.timepicker-picker').show();
        },

        today: function() {
            const today = moment();
            if (this.isValid(today)) {
                this.setValue(today);
            }
        },

        clear: function() {
            this.setValue(null);
        },

        close: function() {
            this.hide();
        },

        // Options methods
        date: function(newDate) {
            if (newDate === undefined) {
                return this.selectedDate ? this.selectedDate.clone() : null;
            }
            
            this.setValue(this.parseDate(newDate));
            return this;
        },

        format: function(newFormat) {
            if (newFormat === undefined) {
                return this.options.format;
            }
            
            this.options.format = newFormat;
            this.format = newFormat || 'L LT';
            this.use24hours = this.format.toLowerCase().indexOf('a') < 1 && 
                            this.format.replace(/\[.*?\]/g, '').indexOf('h') < 1;
            return this;
        },

        minDate: function(newMinDate) {
            if (newMinDate === undefined) {
                return this.options.minDate ? this.options.minDate.clone() : null;
            }
            
            if (newMinDate === false) {
                this.options.minDate = false;
                return this;
            }
            
            const minDate = this.parseDate(newMinDate);
            if (minDate && minDate.isValid()) {
                this.options.minDate = minDate;
                if (this.selectedDate && this.selectedDate.isBefore(minDate)) {
                    this.setValue(minDate.clone());
                }
            }
            
            this.update();
            return this;
        },

        maxDate: function(newMaxDate) {
            if (newMaxDate === undefined) {
                return this.options.maxDate ? this.options.maxDate.clone() : null;
            }
            
            if (newMaxDate === false) {
                this.options.maxDate = false;
                return this;
            }
            
            const maxDate = this.parseDate(newMaxDate);
            if (maxDate && maxDate.isValid()) {
                this.options.maxDate = maxDate;
                if (this.selectedDate && this.selectedDate.isAfter(maxDate)) {
                    this.setValue(maxDate.clone());
                }
            }
            
            this.update();
            return this;
        },

        destroy: function() {
            this.hide();
            
            // Remove event listeners
            if (this.isInput) {
                this.element.off('.datetimepicker');
            } else if (this.component) {
                this.component.off('.datetimepicker');
                this.element.find('input').off('.datetimepicker');
            }
            
            $(window).off('resize.datetimepicker');
            this.picker.remove();
            
            this.element.removeData('DateTimePicker');
            this.element.removeData('date');
        }
    };

    // Default options
    DateTimePicker.defaults = {
        format: false,
        dayViewHeaderFormat: 'MMMM YYYY',
        extraFormats: false,
        stepping: 1,
        minDate: false,
        maxDate: false,
        useCurrent: true,
        collapse: true,
        locale: moment.locale(),
        defaultDate: false,
        disabledDates: false,
        enabledDates: false,
        icons: {
            time: 'glyphicon glyphicon-time',
            date: 'glyphicon glyphicon-calendar',
            up: 'glyphicon glyphicon-chevron-up',
            down: 'glyphicon glyphicon-chevron-down',
            previous: 'glyphicon glyphicon-chevron-left',
            next: 'glyphicon glyphicon-chevron-right',
            today: 'glyphicon glyphicon-screenshot',
            clear: 'glyphicon glyphicon-trash',
            close: 'glyphicon glyphicon-remove'
        },
        tooltips: {
            today: 'Go to today',
            clear: 'Clear selection',
            close: 'Close the picker',
            selectMonth: 'Select Month',
            prevMonth: 'Previous Month',
            nextMonth: 'Next Month',
            selectYear: 'Select Year',
            prevYear: 'Previous Year',
            nextYear: 'Next Year',
            selectDecade: 'Select Decade',
            prevDecade: 'Previous Decade',
            nextDecade: 'Next Decade',
            prevCentury: 'Previous Century',
            nextCentury: 'Next Century'
        },
        useStrict: false,
        sideBySide: false,
        daysOfWeekDisabled: false,
        calendarWeeks: false,
        viewMode: 'days',
        toolbarPlacement: 'default',
        showTodayButton: false,
        showClear: false,
        showClose: false,
        widgetPositioning: {
            horizontal: 'auto',
            vertical: 'auto'
        },
        widgetParent: null,
        ignoreReadonly: false,
        keepOpen: false,
        focusOnShow: true,
        inline: false,
        keepInvalid: false,
        datepickerInput: '.datepickerinput',
        keyBinds: {
            up: function(widget) {
                if (widget && widget.find('.datepicker').is(':visible')) {
                    this.date(this.selectedDate.clone().subtract(7, 'd'));
                } else {
                    this.date(this.selectedDate.clone().add(this.stepping, 'm'));
                }
            },
            down: function(widget) {
                if (!widget) {
                    this.show();
                    return;
                }
                if (widget.find('.datepicker').is(':visible')) {
                    this.date(this.selectedDate.clone().add(7, 'd'));
                } else {
                    this.date(this.selectedDate.clone().subtract(this.stepping, 'm'));
                }
            },
            'control up': function(widget) {
                if (widget && widget.find('.datepicker').is(':visible')) {
                    this.date(this.selectedDate.clone().subtract(1, 'y'));
                } else {
                    this.date(this.selectedDate.clone().add(1, 'h'));
                }
            },
            'control down': function(widget) {
                if (widget && widget.find('.datepicker').is(':visible')) {
                    this.date(this.selectedDate.clone().add(1, 'y'));
                } else {
                    this.date(this.selectedDate.clone().subtract(1, 'h'));
                }
            },
            left: function(widget) {
                if (widget && widget.find('.datepicker').is(':visible')) {
                    this.date(this.selectedDate.clone().subtract(1, 'd'));
                }
            },
            right: function(widget) {
                if (widget && widget.find('.datepicker').is(':visible')) {
                    this.date(this.selectedDate.clone().add(1, 'd'));
                }
            },
            pageUp: function(widget) {
                if (widget && widget.find('.datepicker').is(':visible')) {
                    this.date(this.selectedDate.clone().subtract(1, 'M'));
                }
            },
            pageDown: function(widget) {
                if (widget && widget.find('.datepicker').is(':visible')) {
                    this.date(this.selectedDate.clone().add(1, 'M'));
                }
            },
            enter: function() {
                this.hide();
            },
            escape: function() {
                this.hide();
            },
            'control space': function(widget) {
                if (widget && widget.find('.timepicker').is(':visible')) {
                    widget.find('[data-action="togglePeriod"]').click();
                }
            },
            t: function() {
                this.date(moment());
            },
            'delete': function() {
                this.clear();
            }
        },
        debug: false,
        allowInputToggle: false,
        disabledTimeIntervals: false,
        disabledHours: false,
        enabledHours: false,
        viewDate: false
    };

    // jQuery plugin definition
    $.fn.datetimepicker = function(option) {
        const args = Array.prototype.slice.call(arguments, 1);
        let returnValue = null;

        this.each(function() {
            const $this = $(this);
            let data = $this.data('DateTimePicker');

            if (!data) {
                const options = $.extend(true, {}, $.fn.datetimepicker.defaults, typeof option === 'object' && option);
                $this.data('DateTimePicker', data = new DateTimePicker(this, options));
            }

            if (typeof option === 'string') {
                const method = data[option];
                if (typeof method === 'function') {
                    returnValue = method.apply(data, args);
                    if (returnValue === this) {
                        returnValue = null;
                    }
                }
            }
        });

        return returnValue !== null ? returnValue : this;
    };

    $.fn.datetimepicker.Constructor = DateTimePicker;
    $.fn.datetimepicker.defaults = DateTimePicker.defaults;

    return DateTimePicker;
}));
